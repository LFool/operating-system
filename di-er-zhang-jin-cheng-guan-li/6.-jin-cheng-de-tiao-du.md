# 6. 进程的调度

## 1. 调度的概念

当有一堆任务需要处理的时候，但由于资源有限，这些事情没发同时处理。这就需要确定某种规则来决定处理这些任务的顺序，这就是“调度”研究的问题

## 2. 调度的三个层次

### 2.1 高级调度

先明确一个概念：

* **作业：**一个具体的任务
* 用户向系统提交一个作业 ≈ 用户让操作系统启动一个程序（来处理一个具体的任务）

**高级调度（作业调度）：**按一定的原则从外存的作业后备队列中选择一个作业调入内存，并创建进程。**每个作业只调入一次，调出一次**。作业调入时会建立 PCB，调出时才撤销 PCB 

> 好几个程序需要启动，到底先启动哪个

### 2.2 中级调度

当内存不够时，可能会把某些进程的数据调出到外存。等内存空闲时或者进程需要运行时再重新调入内存中

暂时调到外存等待的进程状态为**挂起状态**。被挂起的进程 PCB 会被组织成挂起队列

**中级调度（内存调度）：**按照某种策略决定将哪个处于挂起的进程重新调入内存。一个进程可能多次调出、调入内存，因此**中级调度**发生的**频率**要比高级调度**高**



#### 补充知识：进程的挂起态 & 七状态模型

暂时调到外存等待的进程状态为**挂起状态（挂起态，suspend）**

挂起态可以分为**就绪挂起**、**阻塞挂起**两种

![](../.gitbook/assets/image%20%2818%29.png)

**挂起 & 阻塞 区别**

两种都是不能获得 CPU 的服务，但是挂起态是将进程从内存调出到外存中，而阻塞态的进程依然在内存中

有的操作系统会把就绪挂起和阻塞挂起分为两个队列，甚至可以根据阻塞的原因将阻塞队列细分为更多的队列

### 2.3 低级调度

低级调度（进程调度 / 处理机调度）：按照某种策略从就绪队列中选取一个进程，将处理机分配给它（内存 -&gt; CPU）

进程调度是操作系统中最基本的一种调度，在一般的操作系统中都必须配置进程调度。进程调度的频率很高，一般几十毫秒一次。

### 2.4 三种调度的联系 & 对比

|  | **要做什么** | **调度发生在...** | **发生频率** | **对进程状态的影响** |
| :---: | :---: | :---: | :---: | :---: |
| 高级调度（作业调度） | 按照某种规则，从后备队列中选择合适的的作业将其调入内存中，并为其创建进程 | 外存 -&gt; 内存（面向作业） | 最低 | 无 -&gt; 创建态 -&gt; 就绪态 |
| 中级调度（内存调度） | 按照某种规则，从挂起队列中选择合适的的进程将其数据调回内存 | 外存 -&gt; 内存（面向进程） | 中等 | 挂起态 -&gt; 就绪态（阻塞挂起 -&gt; 阻塞态） |
| 低级调度（进程调度） | 按照某种规则，从就绪队列中选择一个进程为其分配处理机 | 内存 -&gt; CPU | 最高 | 就绪态 -&gt; 运行态 |

## 3. 进程调度的时机

**需要进行**进程调度与切换的情况

* 当前运行的进程**主动放弃**处理机
  * 进程正常终止
  * 运行过程中发生异常而终止
  * 进程主动请求阻塞（如：等待 I/O）
* 当前运行的进程**被动放弃**处理机
  * 分给进程的时间片用完
  * 有更紧急的事情需要处理（如：I/O 中断）
  * 有更高优先级的进程进入就绪队列

**不能进行**进程调度与切换的请况

* 在**处理机中断的过程中**。中断处理过程复杂，与硬件密切相关，很难做到在中断处理中进行进程切换
* 进程在**操作系统内核程序临界区**中
* 在**原子操作过程中**（原语）。原子操作不可中断，要一起呵成

## 4. 进程调度的方式

**非剥夺调度方式**，又称**非抢占方式**。即，只允许进程主动放弃处理机。在运行过程中即便有更紧迫的任务到达，当前进程依然会继续使用处理机，直到该进程终止或主动要求进入阻塞态

* 实现简单，系统开销小但是无法及时处理紧急任务，适合于早期的批处理系统

**剥夺调度方式**，又称**抢占方式**。当一个进程正在处理机上执行时，如果有一个更重要或更紧急的进程需要使用处理机，则立即暂停正在执行的进程，将处理机分配给更重要紧迫的进程

* 可以优先处理更紧急的进程，也可以实现让各进程按时间片轮询执行的功能（通过时钟中断）。适合于分时系统、实时系统

## 5. 进程的切换 & 过程

“狭义的进程调度”与“进程切换”的区别： 

* **狭义的进程调度**指的是从就绪队列中**选中一个要运行的进程**。（这个进程可以是刚刚被暂停执行的进程，也可能是**另一个进程**，后一种情况就需要**进程切换**）
* **进程切换**是指一个进程让出处理机，由另一个进程占用处理机的过程

**广义的进程调度**包含了**选择一个进程**和**进程切换**两个步骤

**进程切换的过程**主要完成了：

1. 对原来运行进程各种数据的保存
2. 对新的进程各种数据的恢复（如：程序计数器、程序状态字、各种数据寄存器等处理机现场信息，这些信息一般保存在进程控制块）

**注意：进程切换是有代价的**，因此如果**过于频繁**的进行进程**调度**、**切换**，必然会使整个**系统的效率降低**，使系统大部分时间都花在了进程切换上，而真正用于执行进程的时间减少

## 6. 调度算法的评价指标

### 6.1 CPU 利用率

**CPU 利用率：**指 CPU “忙碌” 的时间占总时间的比例

$$\begin{aligned} 利用率 = \frac{忙碌的时间}{总时间} \qquad\end{aligned}$$ 

### 6.2 系统吞吐量

**系统吞吐量：**单位时间内完成作业的数量

$$\begin{aligned} 系统吞吐量 = \frac{总共完成了多少道作业}{总共花了多少时间} \qquad\end{aligned}$$ 

### 6.3 周转时间

对于计算机的用户来说，他很关心**自己的作业从提交到完成花了多少时间**

**周转时间：**指**从作业被提交给系统开始**，到**作业完成为止**的这段时间间隔

周转时间包括四个部分：作业在外存后备队列上等待作业调度（高级调度）的时间、进程在就绪队列上等 待进程调度（低级调度）的时间、进程在CPU上执行的时间、进程等待I/O操作完成的时间。后三项在一个作业的整个处理过程中，可能发生多次

$$（作业）周转时间= 作业完成时间– 作业提交时间$$ 

$$\begin{aligned} 平均周转时间 = \frac{各作业周转时间之和}{作业数} \qquad \end{aligned}$$ 

$$\begin{aligned} 带权周转时间 =  \frac{作业周转时间}{作业实际运行的时间} \qquad   =  \frac{作业完成时间 - 作业提交时间}{作业实际运行的时间} \qquad \end{aligned}$$ 

$$\begin{aligned} 平均带权周转时间 = \frac{各作业带权周转时间之和}{作业数} \qquad \end{aligned}$$ 

### 6.4 等待时间

计算机的用户希望**自己的作业尽可能少的等待处理机**

**等待时间：**指进程 / 作业**处于等待处理机状态时间之和**，等待时间越长，用户满意度越低

对于**进程**来说，等待时间就是指进程建立后**等待被服务的时间之和**，在等待 I/O 完成的期间其实进程也是在被服务的，所以不计入等待时间

对于**作业**来说，不仅要考虑**建立进程后的等待时间，还要加上作业在外存后备队列中等待的时间**

一个作业总共需要被 CPU 服务多久，被 I/O 设备服务多久一般是确定不变的，因此调度算法其实只会影响作业/进程的等待时间。当然，与前面指标类似，也有“**平均等待时间**”来评价整体性能

### 6.5 响应时间

对于计算机用户来说，会希望自己的提交的请求（比如通过键盘输入了一个调试命令）尽早地开始被系统服务、回应

**响应时间：**指从用户**提交请求**到**首次产生响应**所用的时间

