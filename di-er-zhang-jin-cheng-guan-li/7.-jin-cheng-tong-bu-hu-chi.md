# 7. 进程同步 & 互斥

## 1. 什么是同步

我们知道进程具有**异步性**，即各并发执行的进程以不可预知的速度向前推进

但是很多时候，我们需要**多个进程以一定的顺序来执行**，如管道通信，只有写进程先执行后，读进程才可以执行，这就是进程同步需要处理的内容

**同步**亦称**直接制约关系**，它是指完成某种任务而建立的两个或多个进程因为需要在某些位置上**协调**它们的**工作次序**而产生的制约关系。进程间的直接制约关系就是源于它们之间的相互合作

## 2. 什么是互斥

并发需要共享的支持，各个并发的进程不可避免的需要共享一些系统资源（如：内存、打印机、摄像头）

**两种资源共享方式**

* **互斥共享方式：**系统中的某些资源，虽然可以提供给多个进程使用，但是一个时间段内只允许一个进程 访问该资源
* **同时共享方式：**系统中的某些资源，运行一个时间段内由多个进程“同时”对它们进行访问

**临界资源：**一个时间段内只允许一个进程使用的资源。如：物理设备（摄像头、打印机）都属于临界资源，此外还有许多变量、数据、内存缓冲区都属于临界资源

对临界资源的访问，必须**互斥**地进行。互斥亦称**间接制约关系**。**进程互斥**指当一个进程访问某临界资源时，另一个想要访问该临界资源的进程必须等待，当前访问临界资源的进程访问结束，释放该资源后，另一个进程才可以访问临界资源

对临界资源的互斥访问，可以逻辑上分为四个部分：

```c
do {
    /**
     * 进入区
     * 负责检查是否可以进入临界区
     * 若可以进入，则应设置正在访问临界资源的标志(上锁)
     * 以阻止其它进程同时访问临界区
     */
    entry section;
    /**
     * 临界区
     * 访问临界资源的代码
     */
    critical section;
    /**
     * 退出区
     * 负责解除正在访问临界资源的标志(解锁)
     */
    exit section;
    /**
     * 剩余区
     * 做其它处理
     */   
    remainder section;
} while (true)
```

实现对临界资源的**互斥访问**，同时**保证系统整体性能**，需要遵循**四个原则**：

1. **空闲让进：**临界区空闲时，可以允许一个请求进入临界区的进程进入临界区
2. **忙则等待：**当已有进程进入临界区时，其他试图进入临界区的进程必须等待
3. **有限等待：**当请求访问的进程，应保证能在有限的时间内进入临界区（保存不会饥饿）
4. **让权等待：**当进程不能进入临界区，应立即释放处理机，防止进程忙等

## 3. 互斥的软件实现方法

### 3.1 单标志法

算法思想：

```c
int turn = 0; // turn 表示当前允许进入临界区的进程号(表示谦让)

// P0 进程
while (trun != 0);
critical section;
turn = 1;
remainder section;

// P1 进程
while (trun != 1);
critical section;
turn = 0;
remainder section;
```

### 3.2 双标志先检查法

### 3.3 双标志后检查法

### 3.4 Peterson 算法



